<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="G√©n√©ration et gestion d'ordonnances num√©riques s√©curis√©es ‚Äî Hamy International" />
    <title>Ordonnances Num√©riques ‚Äî Hamy International</title>
    <link rel="stylesheet" href="../css/style.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.5.3/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
      .prescription-hero {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: #fff;
        padding: 48px 24px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 32px;
      }
      .prescription-hero h1 {
        font-size: 2.2rem;
        margin-bottom: 12px;
      }
      .prescription-form {
        background: var(--white);
        padding: 32px 24px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        margin-bottom: 32px;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
      }
      .form-section {
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border);
      }
      .form-section:last-child {
        border-bottom: none;
      }
      .form-section h3 {
        color: var(--primary);
        margin-bottom: 16px;
        font-size: 1.1rem;
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      .form-row.full {
        grid-template-columns: 1fr;
      }
      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }
      }
      .prescription-preview {
        background: #fff;
        border: 2px solid var(--primary);
        border-radius: 12px;
        padding: 40px;
        margin-bottom: 32px;
        box-shadow: var(--shadow-lg);
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
      }
      .prescription-header {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 20px;
        margin-bottom: 30px;
        border-bottom: 2px solid var(--primary);
        padding-bottom: 20px;
        align-items: center;
      }
      .prescription-logo {
        font-weight: bold;
        color: var(--primary);
        font-size: 1.2rem;
      }
      .prescription-clinic-info {
        text-align: center;
      }
      .prescription-clinic-info h2 {
        color: var(--primary);
        margin-bottom: 4px;
      }
      .prescription-clinic-info p {
        font-size: 0.9rem;
        color: var(--text-light);
      }
      .prescription-qr {
        text-align: center;
      }
      .prescription-qr canvas {
        border: 1px solid var(--border);
        padding: 8px;
      }
      .prescription-patient {
        margin-bottom: 20px;
        padding: 16px;
        background: var(--primary-light);
        border-radius: 8px;
      }
      .prescription-patient-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 12px;
      }
      .prescription-patient-row:last-child {
        margin-bottom: 0;
      }
      .prescription-medicines {
        margin: 20px 0;
      }
      .medicine-item {
        padding: 12px;
        margin-bottom: 12px;
        border-left: 4px solid var(--secondary);
        background: #f9f9f9;
        border-radius: 4px;
      }
      .medicine-item strong {
        color: var(--primary);
      }
      .prescription-footer {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 2px solid var(--border);
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px;
      }
      .signature-box {
        border-top: 2px solid #000;
        padding-top: 10px;
        text-align: center;
        font-size: 0.9rem;
      }
      .action-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-top: 24px;
        flex-wrap: wrap;
      }
      .btn-print {
        background: var(--primary);
        color: #fff;
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
      }
      .btn-print:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
      }
      .btn-download {
        background: var(--secondary);
        color: #fff;
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
      }
      .btn-download:hover {
        background: #b71616;
        transform: translateY(-2px);
      }
      @media print {
        body {
          background: #fff;
        }
        .prescription-form,
        .action-buttons,
        .prescription-hero,
        header,
        footer,
        .btn-print,
        .btn-download {
          display: none;
        }
        .prescription-preview {
          box-shadow: none;
          border: 1px solid #000;
          max-width: 100%;
          margin: 0;
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <!-- En-t√™te principal -->
    <header class="en-tete" role="banner">
      <div class="logo">
        <img src="../image/Logo.jpg" alt="Logo Hamy International" />
        <div class="titre">
          <h1 class="Pr">Hamy International</h1>
          <p class="slogan">Votre sant√© est notre priorit√©</p>
        </div>
      </div>
      <nav aria-label="Menu principal">
        <ul class="nav-list">
          <li><a href="index.html">Accueil</a></li>
          <li><a href="service.html">Services</a></li>
          <li><a href="specialit√©.html">Sp√©cialistes</a></li>
          <li><a href="rende-vous.html">Prendre RDV</a></li>
          <li><a href="teleconsultation.html">T√©l√©consultation</a></li>
          <li><a href="prescription.html">Ordonnance</a></li>
          <li><a href="paiement.html">Paiement</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>
      </nav>
    </header>

    <main class="principale wrapper" role="main">
      <!-- Hero Section -->
      <div class="prescription-hero">
        <h1>üìã Ordonnances Num√©riques</h1>
        <p>G√©n√©rez, signez et imprimez vos ordonnances m√©dicales s√©curis√©es.</p>
        <p style="font-size: 0.95rem; opacity: 0.9;">Avec QR code biom√©trique ‚Ä¢ Signature √©lectronique ‚Ä¢ Format PDF</p>
      </div>

      <!-- Formulaire de cr√©ation d'ordonnance -->
      <div class="prescription-form">
        <h2 style="color: var(--primary); margin-bottom: 24px;">Cr√©er une ordonnance</h2>

        <!-- Section Informations M√©decin -->
        <div class="form-section">
          <h3>üë®‚Äç‚öïÔ∏è Informations du M√©decin</h3>
          <div class="form-row">
            <div>
              <label>Nom du m√©decin *
                <input type="text" id="doctorName" placeholder="Dr. Nom Pr√©nom" required />
              </label>
            </div>
            <div>
              <label>Sp√©cialit√©
                <input type="text" id="specialty" placeholder="Ex: Cardiologie" />
              </label>
            </div>
          </div>
          <div class="form-row full">
            <label>N¬∞ Licence/Ordre *
              <input type="text" id="licenseNumber" placeholder="Num√©ro de licence" required />
            </label>
          </div>
          <div class="form-row full">
            <label>Signature num√©rique (ou initiales)
              <input type="text" id="doctorSignature" placeholder="Initiales ou identifiant" />
            </label>
          </div>
        </div>

        <!-- Section Informations Patient -->
        <div class="form-section">
          <h3>üë§ Informations du Patient</h3>
          <div class="form-row">
            <div>
              <label>Nom du patient *
                <input type="text" id="patientName" placeholder="Nom complet" required />
              </label>
            </div>
            <div>
              <label>√Çge *
                <input type="number" id="patientAge" placeholder="√Çge" min="0" max="150" required />
              </label>
            </div>
          </div>
          <div class="form-row">
            <div>
              <label>Sexe
                <select id="patientGender">
                  <option value="">-- S√©lectionner --</option>
                  <option value="M">Masculin</option>
                  <option value="F">F√©minin</option>
                  <option value="Autre">Autre</option>
                </select>
              </label>
            </div>
            <div>
              <label>N¬∞ Patient/Dossier
                <input type="text" id="patientID" placeholder="Num√©ro de dossier" />
              </label>
            </div>
          </div>
        </div>

        <!-- Section Diagnostic -->
        <div class="form-section">
          <h3>üîç Diagnostic</h3>
          <div class="form-row full">
            <label>Motif de consultation / Diagnostic *
              <textarea id="diagnosis" rows="3" placeholder="Description des sympt√¥mes et diagnostic" required></textarea>
            </label>
          </div>
        </div>

        <!-- Section M√©dicaments -->
        <div class="form-section">
          <h3>üíä M√©dicaments prescrits</h3>
          <div id="medicinesContainer">
            <div class="medicine-input-group" style="margin-bottom: 16px; padding: 16px; background: var(--primary-light); border-radius: 8px;">
              <div class="form-row">
                <div>
                  <label>M√©dicament *
                    <input type="text" class="medicineName" placeholder="Nom du m√©dicament" required />
                  </label>
                </div>
                <div>
                  <label>Dosage *
                    <input type="text" class="medicineDosage" placeholder="Ex: 500mg" required />
                  </label>
                </div>
              </div>
              <div class="form-row">
                <div>
                  <label>Fr√©quence *
                    <input type="text" class="medicineFrequency" placeholder="Ex: 2x par jour" required />
                  </label>
                </div>
                <div>
                  <label>Dur√©e *
                    <input type="text" class="medicineDuration" placeholder="Ex: 10 jours" required />
                  </label>
                </div>
              </div>
              <div class="form-row full">
                <label>Instructions sp√©ciales
                  <textarea class="medicineInstructions" rows="2" placeholder="Ex: Prendre avec de la nourriture"></textarea>
                </label>
              </div>
              <button type="button" onclick="removeMedicine(this)" class="btn btn-outline" style="margin-top: 8px;">Supprimer ce m√©dicament</button>
            </div>
          </div>
          <button type="button" onclick="addMedicine()" class="btn btn-outline" style="margin-top: 12px;">+ Ajouter un m√©dicament</button>
        </div>

        <!-- Section Notes -->
        <div class="form-section">
          <h3>üìù Notes et recommandations</h3>
          <div class="form-row full">
            <label>Recommandations suppl√©mentaires
              <textarea id="recommendations" rows="3" placeholder="Conseils, pr√©cautions, suivi recommand√©..."></textarea>
            </label>
          </div>
        </div>

        <!-- Bouton de g√©n√©ration -->
        <div style="text-align: center; margin-top: 24px;">
          <button type="button" onclick="generatePrescription()" class="btn btn-primary" style="padding: 14px 32px; font-size: 1.05rem;">
            üëÅÔ∏è Aper√ßu & G√©n√©rer Ordonnance
          </button>
        </div>
      </div>

      <!-- Aper√ßu de l'ordonnance -->
      <div id="prescriptionPreviewContainer" style="display: none;">
        <h2 style="text-align: center; color: var(--primary); margin-bottom: 24px;">Aper√ßu de l'ordonnance</h2>

        <div class="prescription-preview" id="prescriptionPreview">
          <!-- Ent√™te -->
          <div class="prescription-header">
            <div class="prescription-logo">üè• Hamy International</div>
            <div class="prescription-clinic-info">
              <h2>Ordonnance M√©dicale</h2>
              <p>Clinique Hamy International ‚Ä¢ 610 783 753</p>
              <p><span id="previewDate"></span></p>
            </div>
            <div class="prescription-qr" id="qrCodeContainer"></div>
          </div>

          <!-- Informations Patient -->
          <div class="prescription-patient">
            <div class="prescription-patient-row">
              <div><strong>Patient :</strong> <span id="previewPatientName"></span></div>
              <div><strong>√Çge :</strong> <span id="previewPatientAge"></span> ans</div>
            </div>
            <div class="prescription-patient-row">
              <div><strong>Sexe :</strong> <span id="previewPatientGender"></span></div>
              <div><strong>N¬∞ Dossier :</strong> <span id="previewPatientID"></span></div>
            </div>
          </div>

          <!-- Diagnostic -->
          <div>
            <strong style="color: var(--primary);">Diagnostic :</strong>
            <p id="previewDiagnosis" style="margin-top: 8px; padding: 12px; background: #f9f9f9; border-radius: 4px;"></p>
          </div>

          <!-- M√©dicaments -->
          <div class="prescription-medicines">
            <h3 style="color: var(--primary); margin-bottom: 12px;">M√©dicaments prescrits :</h3>
            <div id="previewMedicines"></div>
          </div>

          <!-- Recommandations -->
          <div id="recommendationsDiv" style="display: none;">
            <strong style="color: var(--primary);">Recommandations :</strong>
            <p id="previewRecommendations" style="margin-top: 8px; padding: 12px; background: #f0f8ff; border-radius: 4px;"></p>
          </div>

          <!-- Signature -->
          <div class="prescription-footer">
            <div class="signature-box">
              <strong id="previewDoctorName"></strong><br/>
              <span id="previewSpecialty"></span><br/>
              N¬∞ <span id="previewLicenseNumber"></span>
            </div>
            <div class="signature-box">
              Signature : <span id="previewSignature"></span><br/>
              <span id="previewSignatureDate"></span>
            </div>
          </div>
        </div>

        <!-- Boutons d'action -->
        <div class="action-buttons">
          <button class="btn-print" onclick="printPrescription()">üñ®Ô∏è Imprimer</button>
          <button class="btn-download" onclick="downloadPDF()">üì• T√©l√©charger PDF</button>
          <button class="btn btn-outline" onclick="resetForm()">üîÑ Nouvelle ordonnance</button>
        </div>
      </div>

      <!-- Section Informations -->
      <section style="background: var(--white); padding: 32px 24px; border-radius: 12px; margin-top: 32px; box-shadow: var(--shadow);">
        <h2 style="color: var(--primary); margin-bottom: 20px;">‚ÑπÔ∏è √Ä propos des ordonnances num√©riques</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
          <div style="padding: 16px; background: var(--primary-light); border-radius: 8px;">
            <h4 style="color: var(--primary); margin-bottom: 8px;">üîê S√©curit√©</h4>
            <p style="font-size: 0.95rem; color: var(--text-light);">Chaque ordonnance inclut un QR code unique et une signature num√©rique pour pr√©venir les fraudes.</p>
          </div>
          <div style="padding: 16px; background: var(--primary-light); border-radius: 8px;">
            <h4 style="color: var(--primary); margin-bottom: 8px;">üì± Acc√®s facile</h4>
            <p style="font-size: 0.95rem; color: var(--text-light);">Les patients peuvent acc√©der √† leurs ordonnances via email ou t√©l√©charger le PDF directement.</p>
          </div>
          <div style="padding: 16px; background: var(--primary-light); border-radius: 8px;">
            <h4 style="color: var(--primary); margin-bottom: 8px;">üè™ Compatible pharmacies</h4>
            <p style="font-size: 0.95rem; color: var(--text-light);">Les pharmacies peuvent scanner le QR code pour v√©rifier l'authenticit√© et traiter la prescription.</p>
          </div>
          <div style="padding: 16px; background: var(--primary-light); border-radius: 8px;">
            <h4 style="color: var(--primary); margin-bottom: 8px;">üìä Tra√ßabilit√©</h4>
            <p style="font-size: 0.95rem; color: var(--text-light);">Historique complet des prescriptions conserv√© au dossier du patient pour suivi m√©dical.</p>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="site-footer" style="margin-top: 32px; background: #f8f9fa; padding: 24px; border-top: 1px solid var(--border);">
      <div style="max-width: 1200px; margin: 0 auto; text-align: center; color: var(--muted);">
        <p>¬© 2025 Hamy International. Tous droits r√©serv√©s.</p>
        <p style="margin-top: 8px;"><a href="privacy.html" style="color: var(--primary); text-decoration: none;">Politique de confidentialit√©</a></p>
      </div>
    </footer>

    <script>
      function addMedicine() {
        const container = document.getElementById('medicinesContainer');
        const newMedicine = document.createElement('div');
        newMedicine.className = 'medicine-input-group';
        newMedicine.style.cssText = 'margin-bottom: 16px; padding: 16px; background: var(--primary-light); border-radius: 8px;';
        newMedicine.innerHTML = `
          <div class="form-row">
            <div>
              <label>M√©dicament *
                <input type="text" class="medicineName" placeholder="Nom du m√©dicament" required />
              </label>
            </div>
            <div>
              <label>Dosage *
                <input type="text" class="medicineDosage" placeholder="Ex: 500mg" required />
              </label>
            </div>
          </div>
          <div class="form-row">
            <div>
              <label>Fr√©quence *
                <input type="text" class="medicineFrequency" placeholder="Ex: 2x par jour" required />
              </label>
            </div>
            <div>
              <label>Dur√©e *
                <input type="text" class="medicineDuration" placeholder="Ex: 10 jours" required />
              </label>
            </div>
          </div>
          <div class="form-row full">
            <label>Instructions sp√©ciales
              <textarea class="medicineInstructions" rows="2" placeholder="Ex: Prendre avec de la nourriture"></textarea>
            </label>
          </div>
          <button type="button" onclick="removeMedicine(this)" class="btn btn-outline" style="margin-top: 8px;">Supprimer ce m√©dicament</button>
        `;
        container.appendChild(newMedicine);
      }

      function removeMedicine(button) {
        button.parentElement.remove();
      }

      function generatePrescription() {
        const doctorName = document.getElementById('doctorName').value;
        const patientName = document.getElementById('patientName').value;
        const diagnosis = document.getElementById('diagnosis').value;

        if (!doctorName || !patientName || !diagnosis) {
          alert('Veuillez remplir les champs obligatoires (*)');
          return;
        }

        // Remplir l'aper√ßu
        document.getElementById('previewPatientName').textContent = document.getElementById('patientName').value;
        document.getElementById('previewPatientAge').textContent = document.getElementById('patientAge').value;
        document.getElementById('previewPatientGender').textContent = document.getElementById('patientGender').value || '-';
        document.getElementById('previewPatientID').textContent = document.getElementById('patientID').value || 'N/A';
        document.getElementById('previewDiagnosis').textContent = diagnosis;
        document.getElementById('previewDoctorName').textContent = doctorName;
        document.getElementById('previewSpecialty').textContent = document.getElementById('specialty').value;
        document.getElementById('previewLicenseNumber').textContent = document.getElementById('licenseNumber').value;
        document.getElementById('previewSignature').textContent = document.getElementById('doctorSignature').value || '(Signature)';
        
        const today = new Date().toLocaleDateString('fr-FR');
        document.getElementById('previewDate').textContent = `√âmise le ${today}`;
        document.getElementById('previewSignatureDate').textContent = today;

        // Afficher les recommandations si pr√©sentes
        const recommendations = document.getElementById('recommendations').value;
        if (recommendations) {
          document.getElementById('recommendationsDiv').style.display = 'block';
          document.getElementById('previewRecommendations').textContent = recommendations;
        } else {
          document.getElementById('recommendationsDiv').style.display = 'none';
        }

        // Remplir les m√©dicaments
        const medicinesContainer = document.getElementById('previewMedicines');
        medicinesContainer.innerHTML = '';
        const medicines = document.querySelectorAll('.medicine-input-group');
        medicines.forEach(med => {
          const name = med.querySelector('.medicineName').value;
          const dosage = med.querySelector('.medicineDosage').value;
          const frequency = med.querySelector('.medicineFrequency').value;
          const duration = med.querySelector('.medicineDuration').value;
          const instructions = med.querySelector('.medicineInstructions').value;

          if (name && dosage && frequency && duration) {
            const medicineItem = document.createElement('div');
            medicineItem.className = 'medicine-item';
            medicineItem.innerHTML = `
              <strong>${name}</strong> - ${dosage}<br/>
              Fr√©quence: ${frequency} | Dur√©e: ${duration}
              ${instructions ? `<br/><em>Note: ${instructions}</em>` : ''}
            `;
            medicinesContainer.appendChild(medicineItem);
          }
        });

        // G√©n√©rer le QR code en toute s√©curit√© (protection contre erreur de lib externe)
        try {
          const qrContainer = document.getElementById('qrCodeContainer');
          qrContainer.innerHTML = '';
          const qrData = `Ordonnance - Patient: ${patientName}, Dr: ${doctorName}, Date: ${today}`;
          if (typeof QRCode === 'function') {
            new QRCode(qrContainer, {
              text: qrData,
              width: 100,
              height: 100
            });
          } else {
            // Fallback: afficher le texte si la lib QR n'est pas disponible
            qrContainer.textContent = qrData;
          }
        } catch (err) {
          console.error('Erreur g√©n√©ration QR code:', err);
        }

        // Afficher l'aper√ßu
        document.getElementById('prescriptionPreviewContainer').style.display = 'block';
        // Utiliser scrollIntoView pour compatibilit√©
        try {
          document.getElementById('prescriptionPreviewContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        } catch (err) {
          // fallback si scrollIntoView non support√©
          window.scrollTo({ top: document.getElementById('prescriptionPreviewContainer').offsetTop });
        }
      }

      function printPrescription() {
        window.print();
      }

      function downloadPDF() {
        const element = document.getElementById('prescriptionPreview');
        const opt = {
          margin: 10,
          filename: 'ordonnance_' + new Date().toISOString().slice(0, 10) + '.pdf',
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
        };
        html2pdf().set(opt).from(element).save();
      }

      function resetForm() {
        document.querySelector('.prescription-form').reset();
        document.getElementById('prescriptionPreviewContainer').style.display = 'none';
        document.getElementById('medicinesContainer').innerHTML = `
          <div class="medicine-input-group" style="margin-bottom: 16px; padding: 16px; background: var(--primary-light); border-radius: 8px;">
            <div class="form-row">
              <div>
                <label>M√©dicament *
                  <input type="text" class="medicineName" placeholder="Nom du m√©dicament" required />
                </label>
              </div>
              <div>
                <label>Dosage *
                  <input type="text" class="medicineDosage" placeholder="Ex: 500mg" required />
                </label>
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Fr√©quence *
                  <input type="text" class="medicineFrequency" placeholder="Ex: 2x par jour" required />
                </label>
              </div>
              <div>
                <label>Dur√©e *
                  <input type="text" class="medicineDuration" placeholder="Ex: 10 jours" required />
                </label>
              </div>
            </div>
            <div class="form-row full">
              <label>Instructions sp√©ciales
                <textarea class="medicineInstructions" rows="2" placeholder="Ex: Prendre avec de la nourriture"></textarea>
              </label>
            </div>
            <button type="button" onclick="removeMedicine(this)" class="btn btn-outline" style="margin-top: 8px;">Supprimer ce m√©dicament</button>
          </div>
        `;
      }
    </script>
  </body>
</html>
